<UserControl
    x:Name="self"
    x:Class="Unicord.Universal.Controls.MessageViewer"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Unicord.Universal.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:Microsoft.Toolkit.Uwp.UI.Controls"
    xmlns:dc="using:Unicord.Universal.Controls"
    xmlns:lib="using:Microsoft.UI.Xaml.Controls"
    xmlns:fcu="http://schemas.microsoft.com/winfx/2006/xaml/presentation?IsApiContractPresent(Windows.Foundation.UniversalApiContract, 5)"
    xmlns:wam="using:WamWooWam.Uwp.UI.Controls"
    xmlns:entities="using:DSharpPlus.Entities"
    mc:Ignorable="d" Loaded="UserControl_Loaded" Unloaded="UserControl_Unloaded"
    d:DesignHeight="300"
    d:DesignWidth="400">
    <UserControl.ContextFlyout>
        <MenuFlyout>

            <MenuFlyoutItem Text="Copy" x:Name="copyMenuItem" Icon="Copy"/>

            <MenuFlyoutSeparator/>

            <MenuFlyoutItem x:Name="addReactionMenuItem" x:Load="{x:Bind _canReact}" Text="Add Reaction" Icon="Emoji"/>

            <MenuFlyoutSeparator x:Name="addReactionSeparator" x:Load="{x:Bind _canReact}" />
            
            <MenuFlyoutItem x:Name="profileMenuItem" Text="Profile" Icon="OtherUser" Click="profileMenuItem_Click"/>
            <MenuFlyoutItem Text="Mention" Icon="Send"/>
            <MenuFlyoutItem Text="Message" Icon="Message"/>

            <MenuFlyoutSeparator x:Name="middleSeparator" x:Load="{x:Bind _middleSeparatorVisible}"/>

            <MenuFlyoutItem Text="Change Nickname" x:Name="changeNicknameMenuItem" x:Load="{x:Bind _changeNickname}" Icon="Character"/>
            <MenuFlyoutItem Text="Pin Message" x:Name="pinMessageMenuItem" x:Load="{x:Bind _pinMessages}" Icon="Pin"/>
            <MenuFlyoutItem Text="Kick" Foreground="Red" x:Name="kickMemberMenuItem" x:Load="{x:Bind _kickMembers}" Icon="LeaveChat"/>
            <MenuFlyoutItem Text="Ban" Foreground="Red" x:Name="banMemberMenuItem" x:Load="{x:Bind _banMembers}" Icon="Remove"/>

            <MenuFlyoutSeparator x:Name="bottomSeparator" x:Load="{x:Bind _bottomSeparatorVisible}"/>

            <MenuFlyoutItem Text="Edit Message" x:Name="editMessageMenuItem" x:Load="{x:Bind _canEdit}" Click="editMessageMenuItem_Click" Icon="Edit"/>
            <MenuFlyoutItem Text="Delete Message" x:Name="deleteMessageMenuItem" Visibility="{x:Bind _canDelete, Converter={StaticResource BoolVisibilityConverter}}" Foreground="Orange" Icon="Delete"/>

        </MenuFlyout>
    </UserControl.ContextFlyout>
    <Grid>
        <Rectangle x:Name="bg" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Margin="0,20,0,0"/>
        
        <Grid x:Name="grid">
            <Grid.RowDefinitions>
                <RowDefinition Height="1*"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="50"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <Ellipse 
                x:Name="imageContainer" 
                Visibility="{Binding CollapsedVisibility, ElementName=self}"
                VerticalAlignment="Top" 
                Width="38" Height="38" >
                <Ellipse.Fill>
                    <ImageBrush>
                        <ImageBrush.ImageSource>
                            <BitmapImage UriSource="{Binding Author.NonAnimatedAvatarUrl}" DecodePixelWidth="38" DecodePixelHeight="38"/>
                        </ImageBrush.ImageSource>
                    </ImageBrush>
                </Ellipse.Fill>
            </Ellipse>

            <Grid x:Name="mainGrid" Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid Visibility="{x:Bind CollapsedVisibility}" x:Name="authorNameContent" Margin="7.5,0,5,2.5" Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock x:Name="authorName" FontWeight="Bold" TextWrapping="NoWrap" VerticalAlignment="Bottom" Text="{Binding Author.DisplayName}" Foreground="{Binding Author.ColorBrush, FallbackValue={ThemeResource DefaultTextForegroundThemeBrush}}"></TextBlock>
                    <Border Grid.Column="1" Margin="5,0" CornerRadius="2" Visibility="{Binding Author.IsBot, Converter={StaticResource BoolVisibilityConverter}}" Background="{ThemeResource SystemControlBackgroundAccentBrush}" >
                        <!--<TextBlock Text="&#xE99A;" Width="16" Height="16" Margin="3,2,2,2" FontSize="16" FontFamily="Segoe MDL2 Assets" />-->
                        <TextBlock Text="Bot" FontSize="11" Margin="5,2" Foreground="{ThemeResource ComboBoxItemSelectedForegroundThemeBrush}" />
                    </Border>
                    <!--<TextBlock x:Name="messageDate" Grid.Column="1" Text="{Binding Timestamp.DateTime}" FontSize="12" VerticalAlignment="Bottom" Margin="5,2" Foreground="{ThemeResource ApplicationSecondaryForegroundThemeBrush}" />-->
                    <!--<TextBlock x:Name="edited" Grid.Column="2" Text="(edited)" FontSize="12" VerticalAlignment="Bottom" Margin="0,2" Foreground="{ThemeResource ApplicationSecondaryForegroundThemeBrush}" x:Load="{x:Bind Message.IsEdited}"/>-->
                </Grid>
                <Grid Margin="7.5,0,2.5,0" Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="1*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock x:Name="systemMessageSymbol" Visibility="Collapsed" FontFamily="Segoe MDL2 Assets" FontSize="20" Margin="0,6,10,6" Foreground="{ThemeResource SystemControlForegroundAccentBrush}"/>
                        <Grid x:Name="messageEditContainer" Visibility="Collapsed" Background="{ThemeResource SystemControlBackgroundChromeMediumBrush}" Grid.Column="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="messageEditBox" Text="{Binding Content, Mode=OneWay}" AcceptsReturn="True" TextWrapping="Wrap" MaxHeight="100" fcu:PreviewKeyUp="messageEditBox_PreviewKeyUp" Style="{StaticResource MessageTextBoxStyle}"/>
                            <Button x:Name="messageEditFinishButton" Content="&#xE73E;" Click="messageEditFinishButton_Click" Style="{StaticResource IconButtonStyle}" Grid.Column="1"/>
                            <Button x:Name="messageEditCancelButton" Content="&#xE711;" Click="messageEditCancelButton_Click" Style="{StaticResource IconButtonStyle}" Grid.Column="2"/>
                        </Grid>
                        <wam:MarkdownTextBlock x:Name="markdown" Grid.Column="1" Channel="{x:Bind _channel}" ContextFlyout="{x:Null}" WrapCodeBlock="True" LinkClicked="MarkdownTextBlock_LinkClicked"/>

                    </Grid>
                </Grid>
                <StackPanel Grid.Row="2" x:Name="embeds">

                </StackPanel>
                <ItemsControl x:Name="reactions" Margin="10,0" Grid.Row="3" ItemsSource="{x:Bind _reactions}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="entities:DiscordReaction">
                            <Border Padding="2" Margin="0,0,5,0" Background="{StaticResource SystemControlBackgroundChromeMediumBrush}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Rectangle Grid.ColumnSpan="2" Fill="{ThemeResource SystemControlBackgroundAccentBrush}" Margin="-2" Visibility="{Binding IsMe, Converter={StaticResource BoolVisibilityConverter}}"/>

                                    <TextBlock Visibility="{Binding Emoji.Unicode, Converter={StaticResource HideOnNullConverter}}" FontSize="14" Text="{Binding Emoji.Unicode}" Width="18" Height="18"/>
                                    <Image Source="{Binding Emoji.Url}" Width="18" Height="18"/>

                                    <TextBlock Margin="5,0" Text="{Binding Count}" FontSize="13" Grid.Column="1" VerticalAlignment="Center"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
